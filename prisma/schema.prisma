// prisma/schema.prisma

generator client {
    provider     = "prisma-client"
    output       = "../generated/prisma"
    moduleFormat = "cjs"
}

datasource db {
    provider = "postgresql"
}

model Category {
    id          Int     @id @default(autoincrement())
    name        String  @db.VarChar(150)
    fullName    String? @db.VarChar(250)
    slug        String  @unique @db.VarChar(250)
    description String? @db.Text
    parentId    Int?

    sortOrder Int? @default(500)

    // self-relation (иерархия категорий)
    parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
    children Category[] @relation("CategoryHierarchy")

    products Product[]
    images   CategoryImage[]

    deletedAt DateTime?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([parentId])
    @@index([deletedAt])
}

model Product {
    id Int @id @default(autoincrement())

    name     String  @db.VarChar(150)
    fullName String? @db.VarChar(250)
    slug     String  @unique @db.VarChar(250)

    description String? @db.Text

    price Decimal @db.Decimal(10, 2)

    categoryId Int
    category   Category @relation(fields: [categoryId], references: [id])

    branchProducts BranchProduct[]
    images ProductImage[]

    sortOrder Int @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([categoryId])
    @@index([sortOrder])
}

model Branch {
    id          Int       @id @default(autoincrement())
    name        String    @db.VarChar(150)
    description String?   @db.Text
    address     String    @db.VarChar(250)
    city        String?   @db.VarChar(150)
    region      String?   @db.VarChar(150)
    phone       String?   @db.VarChar(50)
    isActive    Boolean   @default(true)

    branchProducts BranchProduct[] // связь с товарами филиала

    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    @@index([isActive])
}

model BranchProduct {
    id            Int         @id @default(autoincrement())

    productId Int
    productItem   Product     @relation(fields: [productId], references: [id])

    branchId      Int
    branch        Branch      @relation(fields: [branchId], references: [id])

    price         Decimal     @db.Decimal(10, 2)
    stock         Int         @default(0)
    isActive      Boolean     @default(true)

    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    @@index([productId])
    @@index([branchId])
    @@unique([productId, branchId]) // чтобы в филиале не было дублей
}

model ProductImage {
    id        Int     @id @default(autoincrement())

    productId Int
    product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    type      String  @db.VarChar(50)   // main, icon, gallery и т.д.
    url       String  @db.Text          // можно хранить ключ вместо полного URL
    sortOrder Int     @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([productId])
    @@index([type])
    @@index([sortOrder])
}

model CategoryImage {
    id         Int       @id @default(autoincrement())

    categoryId Int
    category   Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    type       String    @db.VarChar(50) // main, icon, banner и т.д.
    url        String    @db.Text
    sortOrder  Int       @default(0)

    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    @@index([categoryId])
    @@index([type])
    @@index([sortOrder])
}


model OutboxEvent {
    id            String       @id @default(uuid())
    topic         String
    key           String?
    eventType     String
    eventVersion  Int          @default(1)
    payload       Json
    status        OutboxStatus @default(PENDING)
    attempts      Int          @default(0)
    lastError     String?
    nextAttemptAt DateTime     @default(now())
    publishedAt   DateTime?
    createdAt     DateTime     @default(now())
    updatedAt     DateTime     @updatedAt

    @@index([status, nextAttemptAt, createdAt])
}

enum OutboxStatus {
    PENDING
    PROCESSING
    SENT
    FAILED
}
